import h5py
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
mpl = plt.matplotlib 
import matplotlib.dates as mdates
from datetime import datetime, timedelta
from astropy.time import Time
from barycorrpy import get_BC_vel, exposure_meter_BC_vel

#GRASS_rv = [-957.6407050387614, -952.23416482121, -951.3767591469299, -957.5228198873564, -956.0500913470426, -956.4334520576242, -950.0235546408566, -950.7776287356118, -950.3273406033297, -948.7720078586276, -952.0022715989958, -953.4446319505525, -948.048558875819, -950.4815875972771, -944.7365044042803, -950.3739699150658, -949.5958105891948, -947.8443765016298, -948.0828147544905, -947.9234315459737, -946.0441413264148, -945.9156609722065, -940.072267988213, -944.1053574155213, -942.2277009671724, -937.3842286039379, -938.8249193082844, -938.9169790916927, -932.8786867552561, -933.400020404843, -933.9631582000947, -934.1371503259635, -932.3089812720171, -930.6324648498428, -930.7369476207504, -928.5194591601108, -929.5285518362675, -930.2435911631677, -929.9497652922053, -927.9252148592116, -921.738089497927, -925.9717679730974, -924.3431983138896, -922.5174240188875, -921.6136897696907, -923.1924306142977, -922.1934402193941, -1092.9586119388687, -1102.6076289110565, -1125.639584125821, -1138.2865737050495, -1162.9225887985178, -1181.5775615999878, -1207.657536558772, -1224.755143977197, -1251.6965525724352, -1269.341921344596, -1295.6722135078987, -1313.8116296496532, -1340.3198341198129, -1356.3138706483355, -1380.7985438990183, -1407.9933446795735, -1430.5254795141334, -1445.071708268718, -1473.4130545540036, -1489.1132771356047, -1511.9837176199205, -1536.098545517824, -1560.0726027494786, -1572.257806466378, -1597.0763113057326, -1617.0155035643118, -1632.876126481834, -1648.2052718565474, -1671.0070573692894, -1674.0818910666726, -1685.6547147651615, -1695.286990124197, -1684.152233571177, -1684.4177949464802, -1675.1729623965132, -1652.142482390169, -1604.4836072540988, -1562.3915285944827, -1506.088740854738, -1426.6676875420198, -1330.1440211164593, -1208.4122569267495, -1085.7888419823876, -953.3011480584493, -674.644570754855, -581.9215182596539, -469.90033433125376, -373.3549269403287, -328.33409132851835, -270.6487544174198, -213.19073510038916, -184.63386905184203, -170.07803104860855, -149.70329701887042, -133.26553042423123, -118.9623894722335, -119.74174727638797, -121.96955716191046, -125.820028477974, -140.06100920247783, -149.27524163449561, -152.92063550076313, -157.950092186689, -171.81350549865672, -186.95768467806116, -206.2725430579626, -213.740678683174, -232.2338643701338, -244.1991505187002, -264.72747210682155, -277.1541048955806, -293.78406914261296, -314.0057395291762, -320.9567539854917, -343.6884942923018, -364.64307817032704, -374.63729881033305, -397.5806674607968, -404.40667007173863, -422.6199392870508, -435.7111294781792, -614.1843496791362, -610.1984070908541, -612.0467518947662, -610.3979679177977, -603.9129178881329, -607.7652364201504, -605.4992864065548, -601.6089711113312, -594.5901379781579, -593.0099809489709, -591.231272406493, -590.7584274302442, -587.7934809442817, -582.8256944658812, -585.8297736500132, -582.4121394511559, -448.4716834730782, -286.99513045156607, -288.2709606057779, -289.33726152295935]
GRASS_rv = [-988.5648555033229, -988.9318152940725, -990.6844776572767, -987.5287138611862, -986.3617787440236, -988.3634704533989, -982.6352134344874, -984.9851973476927, -986.1167015706944, -987.5433552910207, -984.7377695576516, -980.1974827808243, -985.4487230044178, -980.6451989835688, -984.2026333803941, -984.0839766320627, -982.1178808919543, -980.2253063850875, -981.3174051960153, -980.0139358289507, -980.886421013147, -980.1957771011386, -976.8047343725772, -975.9931352599821, -973.1935287525198, -974.0257033963295, -971.1727969024736, -973.0962248289476, -970.2998404910957, -968.9402886035529, -967.8491208161917, -965.4898868812709, -966.5003169680791, -968.2620324270541, -962.4107609028232, -966.3076847104794, -962.1874144501156, -960.2486849427027, -961.4345040022378, -961.2572878649679, -960.0417190185783, -957.7769348819259, -962.2706322180697, -959.5027825510831, -960.1688273552427, -955.2957711663403, -957.6128131530014, -1148.4168055462148, -1165.3676191659538, -1183.358210355167, -1206.3559469045258, -1230.7011558349323, -1245.4984619140412, -1275.6125693376055, -1290.0728997827953, -1311.6372313736963, -1335.6507888457604, -1360.2641745589847, -1378.9103690594216, -1403.3630755933232, -1425.6067788651585, -1454.4425028537842, -1470.3256016630694, -1491.4443880793435, -1512.5686199541462, -1537.0415575577667, -1556.4851131829364, -1580.3995370226708, -1599.880291477655, -1621.4206218396753, -1635.4449267280322, -1660.716205476253, -1677.5681422723733, -1689.421709564745, -1712.3878677927212, -1723.2929876260405, -1737.1549559193145, -1743.3487237913307, -1741.5063357359863, -1745.8752907169685, -1734.193515771895, -1713.9514078160698, -1696.0279667955808, -1654.5976746378465, -1611.5891216469004, -1545.8542932436956, -1460.9216692630794, -1359.3506963380967, -1246.408169833057, -1124.0732544533375, -989.2201163182601, -710.3405778950811, -611.3154053870292, -508.46453630915136, -419.45662717462756, -355.6483767593881, -296.20998563450985, -242.5585667662413, -209.86930898116458, -180.20684099049083, -162.43161316895385, -146.12117631531527, -139.2108849010982, -133.44890365006418, -138.5291138446397, -135.2036424779573, -148.8287812986053, -150.70338886046957, -153.70099320482186, -168.62285039515257, -181.29080897673745, -188.70708406245632, -208.21844595615403, -219.51503656442284, -233.11408556335516, -249.76341270375266, -267.39951594579776, -284.01106340895694, -296.4461195517043, -309.90770429376835, -331.1093030068014, -345.1622818378765, -359.1653093048414, -378.6501818652174, -386.0249549802146, -412.8597688612395, -428.80508987873355, -444.12026790702157, -648.1691143176052, -648.0001095687492, -644.7773410074756, -645.2241362357328, -642.7821741623089, -638.9822786102992, -633.7442201559002, -636.0943407971021, -628.9516088156915, -624.3608944097624, -624.6986567431775, -623.2455737379415, -619.2634902869034, -618.4578935865401, -614.3256233603213, -613.8143190185167, -480.55199992361537, -318.2480724717284, -318.7728948984342, -318.5644311199441]

#read in data
#model
file = h5py.File("model_data.jld2", "r")
RV_list_no_cb = file["RV_list_no_cb"][()]
RV_list_cb  = file["RV_list_cb"][()]
intensity_list = file["intensity_list"][()]
#data 
data_time = np.loadtxt("data/Boulder_Data_bin.txt")[:, 0]
data_rv = np.loadtxt("data/Boulder_Data_bin.txt")[:, 1] * (1.565*10**(-6))
time_stamps_data = []
time_julian = []
for i in data_time:
    dt = datetime.fromtimestamp(i) + timedelta(hours=4)
    time_stamps_data.append(dt)
    time_julian.append((Time(dt)).jd)

vb, warnings, flag = get_BC_vel(JDUTC=time_julian, lat=39.995380 , longi=-105.262390 , alt=165.23, SolSystemTarget='Sun', predictive=False,zmeas=0.0)

data_rv = np.array(data_rv)
data_rv -= data_rv[-1]

GRASS_rv = np.array(GRASS_rv + vb)
GRASS_rv -= GRASS_rv[-1]

RV_list_no_cb = np.array(RV_list_no_cb + vb)
RV_list_no_cb -= RV_list_no_cb[-1]

RV_list_cb = np.array(RV_list_cb + vb)
RV_list_cb -= RV_list_cb[-1]

#rm curve 
fig, axs = plt.subplots(2, sharex=True, sharey=False, gridspec_kw={'hspace': 0, 'height_ratios': [3, 1]})
axs[0].scatter(time_stamps_data[47:-20], data_rv[47:-20], color = 'k', marker = "x", s = 18, label = "Heterodyne RVs") 
axs[0].plot(time_stamps_data[47:-20], RV_list_no_cb[47:-20], color = 'r', linewidth = 2, label = "Model - No CB")
axs[0].plot(time_stamps_data[47:-20], GRASS_rv[47:-20], color = 'b', linewidth = 3, label = "GRASS")
axs[0].xaxis.set_major_formatter(mdates.DateFormatter("%H:%M"))
axs[0].set_xlabel("Time (UTC)", fontsize=12)
axs[0].set_ylabel("RV [m/s]", fontsize=12)
rms_model_no_cb = round(np.sqrt((np.nansum((data_rv[47:-20] - RV_list_no_cb[47:-20])**2))/len(data_rv[47:-20] - RV_list_no_cb[47:-20])),2)
axs[0].text(time_stamps_data[47:-20][-35], -400, "Model RMS {}".format(rms_model_no_cb))
rms_grass_no_cb = round(np.sqrt((np.nansum((data_rv[47:-20] - GRASS_rv[47:-20])**2))/len(data_rv[47:-20] - GRASS_rv[47:-20])),2)
axs[0].text(time_stamps_data[47:-20][-40], -500, "GRASS RMS {}".format(rms_grass_no_cb))
axs[0].legend(fontsize=12)
plt.xticks(fontsize=12)
plt.yticks(fontsize=12)
#residuals
axs[1].scatter(time_stamps_data[47:-20], (data_rv[47:-20]) - RV_list_no_cb[47:-20], color = 'r', marker = "x", s = 3) 
axs[1].scatter(time_stamps_data[47:-20], (data_rv[47:-20]) - GRASS_rv[47:-20], color = 'b', marker = "x", s = 3)  
axs[1].xaxis.set_major_formatter(mdates.DateFormatter("%H:%M"))
axs[1].set_xlabel("Time (UTC)", fontsize=12)
axs[1].set_ylabel("Residuals", fontsize=12) 
plt.xticks(fontsize=12)
plt.yticks(fontsize=12)
plt.savefig("rm_and_residuals.png")
plt.show()

#rm curve 
fig, axs = plt.subplots(2, sharex=True, sharey=False, gridspec_kw={'hspace': 0, 'height_ratios': [3, 1]})
axs[0].scatter(time_stamps_data[47:-20], data_rv[47:-20], color = 'k', marker = "x", s = 18, label = "Heterodyne RVs") 
axs[0].plot(time_stamps_data[47:-20], RV_list_cb[47:-20], color = 'r', linewidth = 3, label = "Model - CB")
axs[0].xaxis.set_major_formatter(mdates.DateFormatter("%H:%M"))
axs[0].set_xlabel("Time (UTC)", fontsize=12)
axs[0].set_ylabel("RV [m/s]", fontsize=12)
rms_model_cb = round(np.sqrt((np.nansum((data_rv[47:-20] - RV_list_cb[47:-20])**2))/len(data_rv[47:-20] - RV_list_cb[47:-20])),2)
axs[0].text(time_stamps_data[47:-20][-40], -400, "Model RMS {}".format(rms_model_cb))
axs[0].legend(fontsize=12)
plt.xticks(fontsize=12)
plt.yticks(fontsize=12)
#residuals
axs[1].scatter(time_stamps_data[47:-20], (data_rv[47:-20]) - RV_list_cb[47:-20], color = 'k', marker = "x", s = 3)  
axs[1].xaxis.set_major_formatter(mdates.DateFormatter("%H:%M"))
axs[1].set_xlabel("Time (UTC)", fontsize=12)
axs[1].set_ylabel("Residuals", fontsize=12) 
plt.xticks(fontsize=12)
plt.yticks(fontsize=12)
plt.savefig("rm_and_residuals_cb.png")
plt.show()