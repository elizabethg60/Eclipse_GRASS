import h5py
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
mpl = plt.matplotlib 
import matplotlib.dates as mdates
from datetime import datetime, timedelta
from astropy.time import Time
from barycorrpy import get_BC_vel, exposure_meter_BC_vel

#GRASS_rv: RV calculated from line profiles + granulation affects on
#GRASS_no_cb: RV calculated from line profiles + granulation affects off
#RV_list_no_cb: RV calculated form weighted projected velocities + no extra CB
#RV_list_cb: RV calculated form weighted projected velocities + with extra CB

GRASS_rv = [-1005.215939197674, -1004.7686770826809, -1001.9593219876023, -1002.6454053411811, -1003.5827813030495, -996.2681607668392, -998.1439349887045, -997.7050655974209, -993.5425463466572, -995.5613660395437, -990.3150371290874, -992.3354765306557, -988.7951059230406, -988.8391475856722, -986.1350385297743, -984.786169417201, -983.305275041737, -983.904800686576, -981.5206647209712, -978.0141491490706, -974.151784103424, -975.4276057954478, -969.895081882916, -977.2062170330993, -969.8294468052911, -976.8416151514537, -984.6168007756422, -1000.1606344659003, -1014.3944606749225, -1032.7563427470723, -1056.3179164803937, -1074.1608936444693, -1099.6090716742835, -1128.677840397866, -1154.589604724531, -1183.5490947869248, -1214.2574583374335, -1248.8038304523318, -1280.068524675061, -1314.3503770282775, -1352.2568524916758, -1388.0693076244804, -1429.59741248881, -1471.6243333758098, -1529.5290912577075, -1565.3712198428866, -1606.0347112188358, -1642.0589536823436, -1670.7654332590287, -1669.5259893338932, -1626.8961481959504, -1492.50285410846, -1162.472785478682, -595.9255288508335, -79.78530742389927, 144.69134655731247, 189.0443069759101, 165.00558504160915, 117.83942752991031, 52.597490519178834, -12.782144177803945, -76.59664548564665, -126.13882537465419, -173.19143363175075, -219.4083947766704, -260.05020701626796, -303.5300903800961, -340.2569072701125, -374.00418247027454, -406.27626151330526, -444.5156916031678, -469.6455139790266, -500.7321235612571, -522.8039364822611, -571.0821059781719, -604.4080091740738, -633.3164680753705, -662.0523549071514, -685.8600025919874, -708.7595775323377, -723.7534872218004, -739.0451815457664, -747.2370041792636, -753.2594644093783, -753.2764269890649, -746.9132207665463, -743.8712529052432, -740.8215201168138, -734.121700468354, -731.5878265361283, -728.9633168699567, -724.0894256624526, -720.4419904009716, -710.4832339649589, -710.2836259979964, -707.2923332623781, -702.559702283273, -697.9860880818201, -694.1769128411963, -684.7176876033129, -686.9076588787286, -679.7951367680333, -682.1471183307538, -672.7585938643916, -671.7798373726739, -667.4522768319927, -662.3128536000497, -658.3200620651388, -652.8720367967043, -650.2859269861561, -646.7032889830255, -642.3461679687433, -640.0620379470437, -635.3872790386048, -627.7098289641666, -626.3609767753798, -618.4275290219339, -615.774415483784, -614.8806166685808, -607.4156455756225, -605.5370661823221, -600.8425150820888, -600.0188610398307, -596.7518463710882, -586.3610693402698, -586.0413288855353, -582.0662889735813, -577.6969941955147, -573.082219325458, -568.8180819346646, -561.6513080835593, -558.7666073035094, -558.2398305809213, -554.3579059413561, -551.067537290397, -545.1813212110972, -537.4398790978188, -538.3528160726205, -534.3587213100027, -535.6849275252634, -529.8833081252383, -524.0687235763404, -521.8828604155649, -514.5950468674356, -516.6205712723228, -505.4326643355932, -509.0058767184227, -502.51391189349783, -498.8419287874237, -490.1663182409417, -489.78758550906537, -482.9558959699977, -478.2679058534566, -475.6023866180984, -469.27517969811385, -472.6869239963692, -466.28815662860427, -466.28879226907185, -463.17862474122234, -458.54365846630617, -453.4133465824625, -449.1763929602494, -445.2215733503703, -442.58452870053856, -441.50916678459413, -435.39628903719785, -433.84555091343486, -427.4158617198867, -428.5000300701488, -424.54358809312316, -420.14805569732624, -416.6011705511839, -412.27233472975075, -410.77198768752476, -408.5194972748003, -400.18612268244226, -398.1558992203671, -391.70082036768827, -389.3696578545626, -385.2964917662968, -383.6232024835276, -378.18075982771506, -377.3048767566452, -374.5736753093306, -372.3796564512021, -371.9193084062828, -364.5571289044919, -361.02367087986266, -359.1388203446303, -358.71219002806924, -350.43889293756155, -353.3015767853112, -347.8573174485338, -340.2058437180135, -342.20213115817796, -337.26287981252597, -337.50236448903536, -335.11567002845067, -335.1455477563812, -330.5374235886387, -327.13880574533266, -324.30616758865045]
GRASS_no_cb = [-1072.9789634907622, -1072.4226346469343, -1070.30572771898, -1065.9640454906496, -1067.222517266768, -1065.3361152410866, -1062.8574391013171, -1061.5821421128096, -1061.829503819309, -1056.6976393214798, -1056.948331709728, -1056.0749617327915, -1054.64087842471, -1053.9988156318557, -1052.1275216055872, -1045.7159685238867, -1048.084802954969, -1049.6146383274431, -1039.7735755822462, -1043.2939779388823, -1041.315143125617, -1036.951073649938, -1039.4284559613518, -1035.8358755804245, -1038.7728128915073, -1041.8884935034416, -1054.3170651408955, -1066.7747903079853, -1088.2271883417488, -1105.3244361615434, -1127.894024468328, -1154.945754849997, -1175.1237137376302, -1203.899345970281, -1233.0565061782163, -1264.7478038783058, -1292.3263069503957, -1323.0356313794568, -1351.7623246101264, -1389.240050157315, -1421.7230302355522, -1453.7448589665564, -1493.2530379983184, -1522.5821488949186, -1574.667438718248, -1611.5892674405598, -1639.0580092806854, -1670.5453982318506, -1679.6705735762068, -1668.2860439426886, -1607.9118165214275, -1451.0834093049061, -1109.0215755104905, -536.2947861219766, -26.643363505391513, 185.52943347977939, 217.53082927984104, 175.5312073517642, 88.68801061806447, 5.010559496109748, -60.15947066181133, -128.46329054115267, -186.67623740353145, -246.68326059453696, -294.1112160750373, -333.92445587746204, -377.5508677634139, -424.5701327505144, -459.4683532676088, -491.798246111673, -526.6037361007885, -553.2661510711096, -579.4559967155969, -606.714898041942, -654.6060411837982, -688.0040435517916, -715.0962429334257, -737.7390929281149, -759.0532303892314, -782.7583379631877, -795.2220706349717, -808.8802810098551, -813.7781992843511, -821.6048474410377, -820.5704267182414, -816.2584856643559, -812.9336540526187, -805.6047823735037, -802.1513840185881, -797.1544000464506, -793.9361175918662, -789.8377961239485, -784.470398166279, -782.7760625310674, -776.857124173659, -773.9331430888994, -767.7403389328862, -763.4615003447208, -759.9537674570156, -755.2679513690823, -752.1529469210208, -748.5510167727091, -743.8500006706461, -742.2615346063577, -738.6942688783037, -733.045428894944, -728.4773075211373, -722.2395261248466, -717.3073554902463, -716.0574984280421, -710.0882056096461, -707.2520427068835, -705.8749598031359, -696.6582537947925, -693.2148364587963, -689.4225236989561, -688.2315775407417, -685.5177391477725, -681.6294582498726, -678.6795922628014, -670.0891740704756, -665.1195120387315, -662.579925071502, -660.2891830066591, -656.3731707790535, -650.004381696247, -645.4424917224927, -646.7786865238062, -639.8482553562148, -636.285030305071, -633.9318943172985, -626.1967489294436, -622.1301414017591, -622.9793290350196, -621.6158209655777, -614.1845306129625, -609.0571016712188, -602.2134654425998, -599.2249163712289, -596.3980676578097, -592.2936905088416, -589.4225361447224, -585.3559516677362, -579.6757215080955, -578.0681258274095, -574.9445184714533, -572.0771739634234, -568.8957040953886, -562.8786160141958, -557.8995338967904, -555.4511027001653, -551.8078662440316, -547.3236154596744, -543.6802500625796, -541.5736138834079, -534.5166394527214, -529.4732196684647, -532.8951468503799, -526.3040170759314, -522.9947159297672, -520.1673740632614, -514.626826575632, -513.5806149593251, -506.4491487624738, -505.44059786564804, -500.7939476907372, -499.35191022717055, -497.7827892300559, -490.1525979651162, -485.8872509185387, -485.47957529618924, -478.0311222249961, -477.61383827453676, -473.84790311518043, -472.99410362189656, -471.2087814204033, -467.2947483645969, -466.1614062006618, -457.72356464449956, -457.1064642088383, -455.0652479118845, -454.0914273867139, -450.8658751493591, -446.15110594615817, -443.50900093758406, -440.2843242296152, -439.04172370173126, -435.3943926631373, -430.8005077103434, -427.8840580875964, -424.61183562483467, -421.7562340785929, -421.565178870607, -417.30337584600954, -414.4288832066924, -409.2334372105789, -407.1658510045279, -399.33265778913994, -394.06047963548207, -394.53829349456305, -396.402067432956, -392.1405176991977]

#read in data
#model
file = h5py.File("data/model_data.jld2", "r")
RV_list_no_cb = file["RV_list_no_cb"][()][20:-100]
RV_list_cb  = file["RV_list_cb"][()][20:-100]
intensity_list = file["intensity_list"][()][20:-100]
#data 
data = pd.read_csv("data/EXPRES_Data.csv")
rv_obs = list(data["rv"][20:-100])
UTC_time = []
time_julian = []
for i in data["tobs"][20:-100]:
    dt = datetime.strptime(i, "%Y-%m-%d %H:%M:%S")
    UTC_time.append(dt)
    time_julian.append((Time(dt)).jd)

vb, warnings, flag = get_BC_vel(JDUTC=time_julian, lat=34.744444 , longi=-111.421944 , alt=235.9152, SolSystemTarget='Sun', predictive=False,zmeas=0.0)

rv_obs = np.array(rv_obs)
rv_obs -= rv_obs[-1]

GRASS_rv = np.array(GRASS_rv[20:-100] + vb)
GRASS_rv -= GRASS_rv[-1]

GRASS_no_cb = np.array(GRASS_no_cb[20:-100] + vb)
GRASS_no_cb -= GRASS_no_cb[-1]

RV_list_no_cb = np.array(RV_list_no_cb + vb)
RV_list_no_cb -= RV_list_no_cb[-1]

RV_list_cb = np.array(RV_list_cb + vb)
RV_list_cb -= RV_list_cb[-1]    

#rm curve 
fig, axs = plt.subplots(2, sharex=True, sharey=False, gridspec_kw={'hspace': 0, 'height_ratios': [3, 1]})
axs[0].scatter(UTC_time, rv_obs, color = 'k', marker = "x", s = 15, label = "EXPRES RVs") 
axs[0].plot(UTC_time, RV_list_no_cb , color = 'r',  label = "Weighted RVs - No CB")
axs[0].plot(UTC_time, GRASS_no_cb, color = 'b', linewidth = 3, label = "Line RVs - No CB")
axs[0].xaxis.set_major_formatter(mdates.DateFormatter("%H:%M"))
axs[0].set_xlabel("Time (UTC)")
axs[0].set_ylabel("RV [m/s]")
rms_model_no_cb = round(np.sqrt((np.nansum((rv_obs - RV_list_no_cb)**2))/len(rv_obs - RV_list_no_cb)),2)
axs[0].text(UTC_time[-40], -400, "Weighted RVs - No CB RMS {}".format(rms_model_no_cb))
rms_grass_no_cb = round(np.sqrt((np.nansum((rv_obs - GRASS_no_cb)**2))/len(rv_obs - GRASS_no_cb)),2)
axs[0].text(UTC_time[-40], -500, "Line RVs - No CB {}".format(rms_grass_no_cb))
axs[0].legend()
#residuals
axs[1].scatter(UTC_time, (rv_obs) - RV_list_no_cb, color = 'r', marker = "x", s = 1)   
axs[1].scatter(UTC_time, (rv_obs) - GRASS_no_cb, color = 'b', marker = "x", s = 3)  
axs[1].xaxis.set_major_formatter(mdates.DateFormatter("%H:%M"))
axs[1].set_xlabel("Time (UTC)")
axs[1].set_ylabel("Residuals") 
plt.savefig("rm_and_residuals_no_cb.png")
plt.show()

#rm curve 
fig, axs = plt.subplots(2, sharex=True, sharey=False, gridspec_kw={'hspace': 0, 'height_ratios': [3, 1]})
axs[0].scatter(UTC_time, rv_obs, color = 'k', marker = "x", s = 15, label = "EXPRES RVs") 
axs[0].plot(UTC_time, RV_list_cb , color = 'r', label = "Weighted RVs - CB")
axs[0].plot(UTC_time, GRASS_rv, color = 'b', linewidth = 3, label = "GRASS")
axs[0].xaxis.set_major_formatter(mdates.DateFormatter("%H:%M"))
axs[0].set_xlabel("Time (UTC)")
axs[0].set_ylabel("RV [m/s]")
rms_model_cb = round(np.sqrt((np.nansum((rv_obs - RV_list_cb)**2))/len(rv_obs - RV_list_cb)),2)
axs[0].text(UTC_time[-40], -400, "Weighted RVs - CB RMS {}".format(rms_model_cb))
rms_grass_no_cb = round(np.sqrt((np.nansum((rv_obs - GRASS_rv)**2))/len(rv_obs - GRASS_rv)),2)
axs[0].text(UTC_time[-40], -500, "GRASS RMS {}".format(rms_grass_no_cb))
axs[0].legend()
#residuals 
axs[1].scatter(UTC_time, (rv_obs) - RV_list_cb, color = 'r', marker = "x", s = 1)  
axs[1].scatter(UTC_time, (rv_obs) - GRASS_rv, color = 'b', marker = "x", s = 3) 
axs[1].xaxis.set_major_formatter(mdates.DateFormatter("%H:%M"))
axs[1].set_xlabel("Time (UTC)")
axs[1].set_ylabel("Residuals") 
plt.savefig("rm_and_residuals_cb.png")
plt.show()