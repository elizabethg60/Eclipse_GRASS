module MyProject 

using SPICE
using Downloads: download
using LinearAlgebra
using NaNMath
using Statistics
using JLD2
using CSV
using DataFrames
using Dates
using ThreadsX
using Distributions
using NaNStatistics
using LsqFit

include("get_kernels.jl")
include("epoch_computations.jl")
include("coordinates.jl")
include("velocity.jl")
include("moon.jl")
include("time_loop.jl")

#set required body paramters as global variables 
#E,S,M radii (units:km)
earth_radius = bodvrd("EARTH", "RADII")[1]	
earth_radius_pole = bodvrd("EARTH", "RADII")[3]	
sun_radius = bodvrd("SUN","RADII")[1]
moon_radius = bodvrd("MOON", "RADII")[1] 

#timestamps taken from actual observations 
reiners_timestamps = ["2015-03-20T7:07:57.2", "2015-03-20T7:09:45.8", "2015-03-20T7:11:34.3", "2015-03-20T7:13:22.9", "2015-03-20T7:15:11.5", "2015-03-20T7:17:00.3", "2015-03-20T7:18:49.7", "2015-03-20T7:20:38.5", "2015-03-20T7:22:27.4", "2015-03-20T7:24:16.5", "2015-03-20T7:26:05.5", "2015-03-20T7:27:53.8", "2015-03-20T7:29:42.5", "2015-03-20T7:31:30.7", "2015-03-20T7:33:19.2", "2015-03-20T7:35:09.5", "2015-03-20T7:36:58.0", "2015-03-20T7:38:46.1", "2015-03-20T7:40:34.6", "2015-03-20T7:42:22.8", "2015-03-20T7:44:11.5", "2015-03-20T7:46:00.1", "2015-03-20T7:47:48.8", "2015-03-20T7:49:37.1", "2015-03-20T7:51:25.3", "2015-03-20T7:53:13.9", "2015-03-20T7:55:02.3", "2015-03-20T7:56:50.7", "2015-03-20T7:58:39.0", "2015-03-20T8:00:27.2", "2015-03-20T8:02:15.7", "2015-03-20T8:04:04.0", "2015-03-20T8:05:53.0", "2015-03-20T8:07:41.4", "2015-03-20T8:09:30.0", "2015-03-20T8:11:18.5", "2015-03-20T8:13:07.1", "2015-03-20T8:14:55.3", "2015-03-20T8:16:43.7", "2015-03-20T8:18:32.1", "2015-03-20T8:20:20.4", "2015-03-20T8:22:09.4", "2015-03-20T8:23:57.7", "2015-03-20T8:25:46.1", "2015-03-20T8:27:34.7", "2015-03-20T8:29:23.0", "2015-03-20T8:31:11.3", "2015-03-20T8:32:59.5", "2015-03-20T8:34:47.9", "2015-03-20T8:36:36.3", "2015-03-20T8:38:54.5", "2015-03-20T8:40:43.0", "2015-03-20T8:42:31.4", "2015-03-20T8:44:19.9", "2015-03-20T8:46:08.5", "2015-03-20T8:47:56.8", "2015-03-20T8:49:45.5", "2015-03-20T8:51:34.0", "2015-03-20T8:53:22.9", "2015-03-20T8:55:11.5", "2015-03-20T8:56:59.6", "2015-03-20T8:58:47.9", "2015-03-20T9:00:36.1", "2015-03-20T9:02:24.8", "2015-03-20T9:04:13.1", "2015-03-20T9:06:01.7", "2015-03-20T9:07:50.2", "2015-03-20T9:09:38.7", "2015-03-20T9:11:27.1", "2015-03-20T9:13:15.5", "2015-03-20T9:15:04.0", "2015-03-20T9:16:53.1", "2015-03-20T9:18:42.1", "2015-03-20T9:20:30.9", "2015-03-20T9:22:19.7", "2015-03-20T9:24:08.5", "2015-03-20T9:25:57.3", "2015-03-20T9:27:45.9", "2015-03-20T9:29:34.7", "2015-03-20T9:31:23.1", "2015-03-20T9:33:11.5", "2015-03-20T9:34:59.9", "2015-03-20T9:36:48.4", "2015-03-20T9:38:37.4", "2015-03-20T9:40:26.3", "2015-03-20T9:42:15.0", "2015-03-20T9:44:03.8", "2015-03-20T9:45:52.2", "2015-03-20T9:47:40.7", "2015-03-20T9:49:29.7", "2015-03-20T9:51:18.4", "2015-03-20T9:53:07.5", "2015-03-20T9:54:55.9", "2015-03-20T9:56:44.9", "2015-03-20T9:58:33.3", "2015-03-20T10:00:21.8", "2015-03-20T10:02:10.1", "2015-03-20T10:03:58.6", "2015-03-20T10:05:47.4", "2015-03-20T10:07:36.2", "2015-03-20T10:09:54.5", "2015-03-20T10:11:43.9", "2015-03-20T10:13:33.6", "2015-03-20T10:15:22.6", "2015-03-20T10:17:11.7", "2015-03-20T10:19:00.9", "2015-03-20T10:20:49.9", "2015-03-20T10:22:38.9", "2015-03-20T10:24:27.9", "2015-03-20T10:26:17.0", "2015-03-20T10:28:07.1", "2015-03-20T10:29:56.1", "2015-03-20T10:31:45.1", "2015-03-20T10:33:34.0", "2015-03-20T10:35:22.9", "2015-03-20T10:37:12.0", "2015-03-20T10:39:01.0", "2015-03-20T10:40:49.9", "2015-03-20T10:42:38.7", "2015-03-20T10:44:27.6", "2015-03-20T10:46:16.8", "2015-03-20T10:48:05.8", "2015-03-20T10:49:54.9", "2015-03-20T10:51:43.6", "2015-03-20T10:53:32.7", "2015-03-20T10:55:21.9", "2015-03-20T10:57:10.8", "2015-03-20T10:58:59.7", "2015-03-20T11:00:49.8", "2015-03-20T11:02:38.6", "2015-03-20T11:04:27.7", "2015-03-20T11:06:16.8", "2015-03-20T11:08:05.7", "2015-03-20T11:09:54.6", "2015-03-20T11:11:43.6", "2015-03-20T11:13:33.1", "2015-03-20T11:15:22.0", "2015-03-20T11:17:10.9", "2015-03-20T11:18:59.9", "2015-03-20T11:20:48.7", "2015-03-20T11:22:37.7", "2015-03-20T11:24:26.7", "2015-03-20T11:26:15.7", "2015-03-20T11:28:04.3", "2015-03-20T11:29:53.0", "2015-03-20T11:31:41.7", "2015-03-20T11:33:30.3", "2015-03-20T11:35:19.0", "2015-03-20T11:37:07.7", "2015-03-20T11:38:56.9", "2015-03-20T11:48:37.5", "2015-03-20T11:50:26.6", "2015-03-20T11:52:15.6", "2015-03-20T11:54:04.2", "2015-03-20T11:55:53.1", "2015-03-20T11:57:41.8", "2015-03-20T11:59:30.5", "2015-03-20T12:01:19.1", "2015-03-20T12:03:07.6"]
reiners_50 = ["2015-03-20T07:08:47.200000", "2015-03-20T07:10:35.800000", "2015-03-20T07:12:24.300000", "2015-03-20T07:14:12.900000", "2015-03-20T07:16:01.500000", "2015-03-20T07:17:50.300000", "2015-03-20T07:19:39.700000", "2015-03-20T07:21:28.500000", "2015-03-20T07:23:17.400000", "2015-03-20T07:25:06.500000", "2015-03-20T07:26:55.500000", "2015-03-20T07:28:43.800000", "2015-03-20T07:30:32.500000", "2015-03-20T07:32:20.700000", "2015-03-20T07:34:09.200000", "2015-03-20T07:35:59.500000", "2015-03-20T07:37:48.000000", "2015-03-20T07:39:36.100000", "2015-03-20T07:41:24.600000", "2015-03-20T07:43:12.800000", "2015-03-20T07:45:01.500000", "2015-03-20T07:46:50.100000", "2015-03-20T07:48:38.800000", "2015-03-20T07:50:27.100000", "2015-03-20T07:52:15.300000", "2015-03-20T07:54:03.900000", "2015-03-20T07:55:52.300000", "2015-03-20T07:57:40.700000", "2015-03-20T07:59:29.000000", "2015-03-20T08:01:17.200000", "2015-03-20T08:03:05.700000", "2015-03-20T08:04:54.000000", "2015-03-20T08:06:43.000000", "2015-03-20T08:08:31.400000", "2015-03-20T08:10:20.000000", "2015-03-20T08:12:08.500000", "2015-03-20T08:13:57.100000", "2015-03-20T08:15:45.300000", "2015-03-20T08:17:33.700000", "2015-03-20T08:19:22.100000", "2015-03-20T08:21:10.400000", "2015-03-20T08:22:59.400000", "2015-03-20T08:24:47.700000", "2015-03-20T08:26:36.100000", "2015-03-20T08:28:24.700000", "2015-03-20T08:30:13.000000", "2015-03-20T08:32:01.300000", "2015-03-20T08:33:49.500000", "2015-03-20T08:35:37.900000", "2015-03-20T08:37:26.300000", "2015-03-20T08:39:44.500000", "2015-03-20T08:41:33.000000", "2015-03-20T08:43:21.400000", "2015-03-20T08:45:09.900000", "2015-03-20T08:46:58.500000", "2015-03-20T08:48:46.800000", "2015-03-20T08:50:35.500000", "2015-03-20T08:52:24.000000", "2015-03-20T08:54:12.900000", "2015-03-20T08:56:01.500000", "2015-03-20T08:57:49.600000", "2015-03-20T08:59:37.900000", "2015-03-20T09:01:26.100000", "2015-03-20T09:03:14.800000", "2015-03-20T09:05:03.100000", "2015-03-20T09:06:51.700000", "2015-03-20T09:08:40.200000", "2015-03-20T09:10:28.700000", "2015-03-20T09:12:17.100000", "2015-03-20T09:14:05.500000", "2015-03-20T09:15:54.000000", "2015-03-20T09:17:43.100000", "2015-03-20T09:19:32.100000", "2015-03-20T09:21:20.900000", "2015-03-20T09:23:09.700000", "2015-03-20T09:24:58.500000", "2015-03-20T09:26:47.300000", "2015-03-20T09:28:35.900000", "2015-03-20T09:30:24.700000", "2015-03-20T09:32:13.100000", "2015-03-20T09:34:01.500000", "2015-03-20T09:35:49.900000", "2015-03-20T09:37:38.400000", "2015-03-20T09:39:27.400000", "2015-03-20T09:41:16.300000", "2015-03-20T09:43:05.000000", "2015-03-20T09:44:53.800000", "2015-03-20T09:46:42.200000", "2015-03-20T09:48:30.700000", "2015-03-20T09:50:19.700000", "2015-03-20T09:52:08.400000", "2015-03-20T09:53:57.500000", "2015-03-20T09:55:45.900000", "2015-03-20T09:57:34.900000", "2015-03-20T09:59:23.300000", "2015-03-20T10:01:11.800000", "2015-03-20T10:03:00.100000", "2015-03-20T10:04:48.600000", "2015-03-20T10:06:37.400000", "2015-03-20T10:08:26.200000", "2015-03-20T10:10:44.500000", "2015-03-20T10:12:33.900000", "2015-03-20T10:14:23.600000", "2015-03-20T10:16:12.600000", "2015-03-20T10:18:01.700000", "2015-03-20T10:19:50.900000", "2015-03-20T10:21:39.900000", "2015-03-20T10:23:28.900000", "2015-03-20T10:25:17.900000", "2015-03-20T10:27:07.000000", "2015-03-20T10:28:57.100000", "2015-03-20T10:30:46.100000", "2015-03-20T10:32:35.100000", "2015-03-20T10:34:24.000000", "2015-03-20T10:36:12.900000", "2015-03-20T10:38:02.000000", "2015-03-20T10:39:51.000000", "2015-03-20T10:41:39.900000", "2015-03-20T10:43:28.700000", "2015-03-20T10:45:17.600000", "2015-03-20T10:47:06.800000", "2015-03-20T10:48:55.800000", "2015-03-20T10:50:44.900000", "2015-03-20T10:52:33.600000", "2015-03-20T10:54:22.700000", "2015-03-20T10:56:11.900000", "2015-03-20T10:58:00.800000", "2015-03-20T10:59:49.700000", "2015-03-20T11:01:39.800000", "2015-03-20T11:03:28.600000", "2015-03-20T11:05:17.700000", "2015-03-20T11:07:06.800000", "2015-03-20T11:08:55.700000", "2015-03-20T11:10:44.600000", "2015-03-20T11:12:33.600000", "2015-03-20T11:14:23.100000", "2015-03-20T11:16:12.000000", "2015-03-20T11:18:00.900000", "2015-03-20T11:19:49.900000", "2015-03-20T11:21:38.700000", "2015-03-20T11:23:27.700000", "2015-03-20T11:25:16.700000", "2015-03-20T11:27:05.700000", "2015-03-20T11:28:54.300000", "2015-03-20T11:30:43.000000", "2015-03-20T11:32:31.700000", "2015-03-20T11:34:20.300000", "2015-03-20T11:36:09.000000", "2015-03-20T11:37:57.700000", "2015-03-20T11:39:46.900000", "2015-03-20T11:49:27.500000", "2015-03-20T11:51:16.600000", "2015-03-20T11:53:05.600000", "2015-03-20T11:54:54.200000", "2015-03-20T11:56:43.100000", "2015-03-20T11:58:31.800000", "2015-03-20T12:00:20.500000", "2015-03-20T12:02:09.100000", "2015-03-20T12:03:57.600000"]

lambda_nm = [303.327, 310.843, 320.468, 329.897, 349.947, 365.875, 374.086, 390.915, 401.970, 416.319, 427.930, 443.885, 445.125, 457.345, 477.427, 492.905, 519.930, 541.76, 559.95, 579.88, 610.975, 640.97, 669.4, 700.875, 748.71, 811.76, 869.6, 948.85, 1046.6, 1098.95]
a0 = [0.08011, 0.08160, 0.08833, 0.09188, 0.11012, 0.12828, 0.12579, 0.12995, 0.12323, 0.12814, 0.14249, 0.16220, 0.15248, 0.16604, 0.19571, 0.20924, 0.23695, 0.26073, 0.26892, 0.28392, 0.30854, 0.33644, 0.34685, 0.37885, 0.40627, 0.42977, 0.45396, 0.47855, 0.49870, 0.51149]
a1 = [0.70695, 0.71609, 0.77285, 0.92459, 1.02168, 1.04969, 0.85402, 0.91836, 1.08648, 1.19947, 1.28796, 1.24893, 1.38517, 1.38544, 1.30551, 1.30798, 1.29927, 1.27428, 1.34319, 1.36896, 1.3662, 1.30590, 1.37539, 1.25553, 1.22842, 1.25182, 1.25101, 1.19813, 1.21429, 1.19354]
a2 = [0.4991, 0.69685, 0.65382, 0.19604, -0.10924, 0.17482, 0.54601, -0.07566, -0.43974, -0.84407, -1.19564, -0.92165, -1.49615, -1.52275, -1.25845, -1.20411, -1.28034, -1.30352, -1.58427, -1.75998, -1.83572, -1.79238, -2.04425, -1.70908, -1.67877, -1.85164, -2.02958, -1.86296, -2.06976, -2.00174]
a3 = [-0.31080, -0.87703, -1.04647, -0.39546, -0.00055, -1.13371, -1.15048, 0.19149, 0.45912, 1.07201, 1.68603, 0.89978, 1.99886, 2.00232, 1.50626, 1.21505, 1.37760, 1.47085, 1.91271, 2.22154, 2.33221, 2.4504, 2.70493, 2.19647, 2.05535, 2.31949, 2.7541, 2.36939, 2.80703, 2.66936]
a4 = [-0.02177, 0.47008, 0.72921, 0.23599, -0.08688, 1.23882, 0.88928, -0.28712, -0.32759, -0.79537, -1.36658, -0.50148, -1.48155, -1.45969, -1.05472, -0.67196, -0.85054, -0.96618, -1.3135, -1.56074, -1.63082, -1.89979, -1.9429, -1.59554, -1.39972, -1.59101, -2.02287, -1.64367, -2.05247, -1.94981]
a5 = [0.04642, -0.0876, -0.19775, -0.05303, 0.06487, -0.4599, -0.26462, 0.12298, 0.0985, 0.23982, 0.44572, 0.1122, 0.44119, 0.42864, 0.30570, 0.14381, 0.21706, 0.26384, 0.37295, 0.4463, 0.45959, 0.59943, 0.55999, 0.47378, 0.38845, 0.44155, 0.59338, 0.46056, 0.60221, 0.57715]

#linear interpolation for convective blueshift from reiners 2016
AA = AbstractArray
function linear_interp(xs::AA{T,1}, ys::AA{T,1}; bc::T=NaN) where T<:Float64
    function f(x)
        if (((x < first(xs)) | (x > last(xs))) & !isnan(bc))
            return bc
        elseif x <= first(xs)
            return first(ys)
        elseif x >= last(xs)
            return last(ys)
        else

            i = searchsortedfirst(xs, x) - 1
            i0 = clamp(i, firstindex(ys), lastindex(ys))
            i1 = clamp(i+1, firstindex(ys), lastindex(ys))
            return (ys[i0] * (xs[i1] - x) + ys[i1] * (x - xs[i0])) / (xs[i1] - xs[i0])
        end
    end
    return f
end

file = DataFrame(CSV.File("data/convective_blueshift.csv"))
blueshift_values = reverse((file." blueshift"))
mu_values = reverse(file."mu")
convective_blueshift_interpol = linear_interp(mu_values, blueshift_values)
end 